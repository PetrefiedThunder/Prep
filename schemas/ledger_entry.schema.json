{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://prep.com/schemas/ledger_entry.v1.json",
  "title": "LedgerEntry",
  "description": "Double-entry ledger entry for financial transactions (GAAP-compliant)",
  "type": "object",
  "required": [
    "entry_id",
    "transaction_id",
    "account_type",
    "entry_type",
    "amount",
    "currency",
    "booking_id",
    "vendor_id",
    "created_at"
  ],
  "properties": {
    "entry_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for the ledger entry"
    },
    "transaction_id": {
      "type": "string",
      "format": "uuid",
      "description": "Transaction group ID (debits and credits share same transaction_id)"
    },
    "transaction_date": {
      "type": "string",
      "format": "date-time",
      "description": "When the transaction occurred (business date)"
    },
    "posted_date": {
      "type": "string",
      "format": "date-time",
      "description": "When the entry was posted to the ledger"
    },
    "account_type": {
      "type": "string",
      "enum": [
        "cash",
        "accounts_receivable",
        "accounts_payable",
        "revenue",
        "tax_liability",
        "platform_fee_revenue",
        "stripe_fees",
        "host_payout",
        "refund_liability",
        "deposit_liability",
        "commission_revenue"
      ],
      "description": "Chart of accounts classification"
    },
    "account_code": {
      "type": "string",
      "pattern": "^[0-9]{4}$",
      "description": "4-digit account code (e.g., 1000, 4000, 5000)"
    },
    "entry_type": {
      "type": "string",
      "enum": ["debit", "credit"],
      "description": "Debit or credit entry"
    },
    "amount": {
      "type": "number",
      "minimum": 0,
      "multipleOf": 0.01,
      "description": "Amount in cents or smallest currency unit"
    },
    "currency": {
      "type": "string",
      "pattern": "^[A-Z]{3}$",
      "default": "USD",
      "description": "ISO 4217 currency code"
    },
    "booking_id": {
      "type": "string",
      "format": "uuid",
      "description": "Reference to associated booking"
    },
    "vendor_id": {
      "type": "string",
      "format": "uuid",
      "description": "Reference to vendor/operator"
    },
    "facility_id": {
      "type": "string",
      "format": "uuid",
      "description": "Reference to facility/property"
    },
    "counterparty": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["vendor", "guest", "jurisdiction", "platform", "payment_processor"]
        },
        "id": {
          "type": "string",
          "description": "ID of the counterparty"
        },
        "name": {
          "type": "string",
          "description": "Name of the counterparty"
        }
      },
      "additionalProperties": false
    },
    "payment_details": {
      "type": "object",
      "properties": {
        "payment_intent_id": {
          "type": "string",
          "description": "Stripe PaymentIntent ID"
        },
        "transfer_id": {
          "type": "string",
          "description": "Stripe Transfer ID (for Connect payouts)"
        },
        "payout_id": {
          "type": "string",
          "description": "Stripe Payout ID"
        },
        "payment_method": {
          "type": "string",
          "enum": ["card", "bank_transfer", "ach", "wire"]
        }
      },
      "additionalProperties": false
    },
    "tax_details": {
      "type": "object",
      "properties": {
        "tax_type": {
          "type": "string",
          "enum": ["TOT", "sales_tax", "vat", "occupancy_tax", "other"]
        },
        "tax_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Tax rate as decimal"
        },
        "jurisdiction": {
          "type": "string",
          "description": "Taxing jurisdiction (e.g., 'City of San Francisco')"
        },
        "tax_id": {
          "type": "string",
          "description": "Tax remittance ID or reference number"
        }
      },
      "additionalProperties": false
    },
    "reconciliation": {
      "type": "object",
      "properties": {
        "reconciled": {
          "type": "boolean",
          "default": false,
          "description": "Whether this entry has been reconciled"
        },
        "reconciled_at": {
          "type": "string",
          "format": "date-time"
        },
        "reconciled_by": {
          "type": "string",
          "description": "User ID who reconciled"
        },
        "bank_statement_date": {
          "type": "string",
          "format": "date"
        },
        "bank_reference": {
          "type": "string",
          "description": "Bank statement reference number"
        }
      },
      "additionalProperties": false
    },
    "description": {
      "type": "string",
      "maxLength": 500,
      "description": "Human-readable description of the entry"
    },
    "memo": {
      "type": "string",
      "maxLength": 1000,
      "description": "Additional notes or memo"
    },
    "fiscal_period": {
      "type": "object",
      "properties": {
        "year": {
          "type": "integer",
          "minimum": 2020,
          "maximum": 2100
        },
        "quarter": {
          "type": "integer",
          "minimum": 1,
          "maximum": 4
        },
        "month": {
          "type": "integer",
          "minimum": 1,
          "maximum": 12
        }
      },
      "additionalProperties": false
    },
    "audit": {
      "type": "object",
      "properties": {
        "created_by": {
          "type": "string",
          "description": "User or system ID that created this entry"
        },
        "source_system": {
          "type": "string",
          "enum": ["booking_service", "payment_service", "manual", "migration", "correction"],
          "description": "System that originated this entry"
        },
        "correction_of": {
          "type": "string",
          "format": "uuid",
          "description": "If this is a correction, reference to original entry"
        },
        "is_correction": {
          "type": "boolean",
          "default": false
        },
        "is_reversal": {
          "type": "boolean",
          "default": false
        }
      },
      "additionalProperties": false
    },
    "immutable": {
      "type": "boolean",
      "default": true,
      "description": "Ledger entries are immutable by default (use corrections instead of edits)"
    },
    "metadata": {
      "type": "object",
      "description": "Custom key-value metadata",
      "additionalProperties": {
        "type": "string"
      }
    },
    "created_at": {
      "type": "string",
      "format": "date-time"
    }
  },
  "additionalProperties": false
}
