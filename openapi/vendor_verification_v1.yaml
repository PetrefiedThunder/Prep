openapi: 3.0.3
info:
  title: Prep Vendor Verification API
  description: |
    API for onboarding and verifying vendors for shared/commercial kitchens.

    **Product Promise:**
    We help kitchen operators onboard and verify vendors faster with structured checks.
    We do NOT guarantee full legal compliance.

    **Tenancy:**
    All resources are implicitly scoped to the authenticated tenant derived from `X-Prep-Api-Key`.
  version: 1.0.0
  contact:
    name: Prep API Support
servers:
  - url: http://localhost:8003
    description: Development server

security:
  - ApiKeyAuth: []

paths:
  /api/v1/vendors:
    post:
      summary: Create or update a vendor
      description: |
        Idempotent upsert on (tenant_id, external_id).
        Always returns 200 (create or update), never 409.
      operationId: createOrUpdateVendor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VendorRequest'
      responses:
        '200':
          description: Vendor created or updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VendorResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized - invalid or missing API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      summary: List vendors
      description: Lists all vendors for the authenticated tenant
      operationId: listVendors
      parameters:
        - name: status
          in: query
          description: Filter by vendor status
          required: false
          schema:
            $ref: '#/components/schemas/VendorStatus'
        - name: limit
          in: query
          description: Maximum number of results to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Number of results to skip
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of vendors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VendorListResponse'
        '401':
          description: Unauthorized - invalid or missing API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/vendors/{vendorId}:
    get:
      summary: Get vendor details
      description: Retrieve details for a specific vendor
      operationId: getVendor
      parameters:
        - name: vendorId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Vendor details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VendorResponse'
        '404':
          description: Vendor not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/vendors/{vendorId}/documents:
    post:
      summary: Create a vendor document
      description: |
        Creates a vendor document record and returns a presigned upload URL for MinIO/S3.
        The client should use the presigned URL to upload the actual file.
      operationId: createVendorDocument
      parameters:
        - name: vendorId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DocumentRequest'
      responses:
        '200':
          description: Document created with presigned upload URL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentUploadResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Vendor not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      summary: List vendor documents
      description: List all documents for a specific vendor
      operationId: listVendorDocuments
      parameters:
        - name: vendorId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of documents
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/DocumentResponse'
                  total:
                    type: integer
        '404':
          description: Vendor not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/vendors/{vendorId}/verifications:
    post:
      summary: Trigger a verification run
      description: |
        Triggers a verification run for a vendor in a jurisdiction and optional kitchen.
        Supports optional Idempotency-Key header to deduplicate repeats.
      operationId: createVerification
      parameters:
        - name: vendorId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: Idempotency-Key
          in: header
          required: false
          description: Optional idempotency key to prevent duplicate verification runs
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerificationRequest'
      responses:
        '200':
          description: Verification run initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Vendor not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/vendors/{vendorId}/verifications/{verificationId}:
    get:
      summary: Get verification details
      description: Returns full details of a verification run including decision and check results
      operationId: getVerification
      parameters:
        - name: vendorId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: verificationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Verification details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationDetail'
        '404':
          description: Verification or vendor not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-Prep-Api-Key
      description: API key that resolves to a tenant_id

  schemas:
    ErrorResponse:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Machine-readable error code
          example: vendor_not_found
        message:
          type: string
          description: Human-readable error message
          example: The specified vendor was not found
        details:
          type: object
          description: Optional additional error details
          additionalProperties: true

    Location:
      type: object
      required:
        - country
      properties:
        country:
          type: string
          description: ISO 3166-1 alpha-2 country code
          example: US
        state:
          type: string
          description: State or province code
          example: CA
        city:
          type: string
          description: City name
          example: San Francisco

    ContactInfo:
      type: object
      properties:
        email:
          type: string
          format: email
          example: vendor@example.com
        phone:
          type: string
          example: +1-415-555-0123

    VendorStatus:
      type: string
      enum:
        - onboarding
        - verified
        - rejected
        - expiring
      description: Current status of the vendor

    VendorRequest:
      type: object
      required:
        - external_id
        - legal_name
        - primary_location
      properties:
        external_id:
          type: string
          description: Tenant's own identifier for this vendor
          example: vendor-12345
        legal_name:
          type: string
          description: Legal business name
          example: "ABC Catering LLC"
        doing_business_as:
          type: string
          description: DBA name (optional)
          example: "ABC Catering"
        contact:
          $ref: '#/components/schemas/ContactInfo'
        tax_id_last4:
          type: string
          pattern: '^\d{4}$'
          description: Last 4 digits of tax ID (optional)
          example: "1234"
        primary_location:
          $ref: '#/components/schemas/Location'

    VendorResponse:
      type: object
      required:
        - vendor_id
        - external_id
        - legal_name
        - status
        - primary_location
        - created_at
        - updated_at
      properties:
        vendor_id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        external_id:
          type: string
          example: vendor-12345
        legal_name:
          type: string
          example: "ABC Catering LLC"
        doing_business_as:
          type: string
          example: "ABC Catering"
        status:
          $ref: '#/components/schemas/VendorStatus'
        primary_location:
          $ref: '#/components/schemas/Location'
        contact:
          $ref: '#/components/schemas/ContactInfo'
        tax_id_last4:
          type: string
          example: "1234"
        created_at:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"

    VendorListResponse:
      type: object
      required:
        - items
        - total
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/VendorResponse'
        total:
          type: integer
          description: Total number of vendors matching the filter

    DocumentType:
      type: string
      enum:
        - business_license
        - food_handler_card
        - liability_insurance
        - other
      description: Type of vendor document

    DocumentRequest:
      type: object
      required:
        - type
        - jurisdiction
        - file_name
        - content_type
      properties:
        type:
          $ref: '#/components/schemas/DocumentType'
        jurisdiction:
          $ref: '#/components/schemas/Location'
          description: Jurisdiction where this document is valid
        expires_on:
          type: string
          format: date
          description: Expiration date (optional for now)
          example: "2026-12-31"
        file_name:
          type: string
          description: Original filename
          example: "business_license.pdf"
        content_type:
          type: string
          description: MIME type of the file
          example: "application/pdf"

    DocumentUploadResponse:
      type: object
      required:
        - document_id
        - upload_url
        - upload_expires_in
      properties:
        document_id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174001"
        upload_url:
          type: string
          format: uri
          description: Presigned URL for uploading the document
          example: "https://s3.amazonaws.com/bucket/key?signature=..."
        upload_expires_in:
          type: integer
          description: Number of seconds until the upload URL expires
          example: 3600

    DocumentResponse:
      type: object
      required:
        - document_id
        - type
        - jurisdiction
        - created_at
      properties:
        document_id:
          type: string
          format: uuid
        type:
          $ref: '#/components/schemas/DocumentType'
        jurisdiction:
          $ref: '#/components/schemas/Location'
        expires_on:
          type: string
          format: date
        file_name:
          type: string
        content_type:
          type: string
        storage_key:
          type: string
          description: Object key in storage
        created_at:
          type: string
          format: date-time

    VerificationStatus:
      type: string
      enum:
        - pending_documents
        - in_review
        - passed
        - failed
        - expired
        - revoked
      description: Status of a verification run

    VerificationRequest:
      type: object
      required:
        - jurisdiction
        - purpose
      properties:
        kitchen_id:
          type: string
          description: Optional kitchen identifier
          example: "kitchen-abc-123"
        jurisdiction:
          $ref: '#/components/schemas/Location'
          description: Jurisdiction for verification
        purpose:
          type: string
          description: Purpose of verification
          example: "shared_kitchen_rental"
        requested_by:
          type: string
          description: Tenant's user ID who requested verification
          example: "user-123"
        callback_url:
          type: string
          format: uri
          description: Optional callback URL (can be ignored for now)
          example: "https://example.com/webhooks/verification"

    VerificationResponse:
      type: object
      required:
        - verification_id
        - vendor_id
        - status
        - jurisdiction
      properties:
        verification_id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174002"
        vendor_id:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/VerificationStatus'
        jurisdiction:
          $ref: '#/components/schemas/Location'
        kitchen_id:
          type: string

    DecisionOutcome:
      type: string
      enum:
        - pass
        - fail
        - warn
      description: Overall decision outcome

    CheckStatus:
      type: string
      enum:
        - pass
        - fail
        - warn
      description: Status of an individual check

    CheckResult:
      type: object
      required:
        - code
        - status
      properties:
        code:
          type: string
          description: Machine-readable check code
          example: "business_license_present"
        status:
          $ref: '#/components/schemas/CheckStatus'
        details:
          type: string
          description: Human-readable details
          example: "Business license document found and valid"
        regulation_version:
          type: string
          description: Version of regulation checked
          example: "sfph_2025-09-01"
        evidence:
          type: array
          items:
            type: object
            properties:
              document_id:
                type: string
                format: uuid
              note:
                type: string

    Decision:
      type: object
      required:
        - overall
        - score
        - check_results
      properties:
        overall:
          $ref: '#/components/schemas/DecisionOutcome'
        score:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Compliance score (0-1)
          example: 0.97
        check_results:
          type: array
          items:
            $ref: '#/components/schemas/CheckResult'

    Recommendation:
      type: object
      required:
        - summary
      properties:
        summary:
          type: string
          description: Summary of recommendation
          example: "Vendor has all required documents and is approved for operation"
        operator_action:
          type: string
          description: Recommended action for operator
          example: "Proceed with onboarding"

    VerificationDetail:
      type: object
      required:
        - verification_id
        - vendor_id
        - status
        - jurisdiction
        - decision
        - recommendation
        - ruleset_name
        - regulation_version
        - engine_version
        - initiated_from
        - created_at
      properties:
        verification_id:
          type: string
          format: uuid
        vendor_id:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/VerificationStatus'
        evaluated_at:
          type: string
          format: date-time
          description: When the verification was evaluated
        jurisdiction:
          $ref: '#/components/schemas/Location'
        kitchen_id:
          type: string
        decision:
          $ref: '#/components/schemas/Decision'
        recommendation:
          $ref: '#/components/schemas/Recommendation'
        ruleset_name:
          type: string
          description: Name of the ruleset used
          example: "sf_shared_kitchen_v1"
        regulation_version:
          type: string
          description: Version of regulations evaluated
          example: "sfph_2025-09-01"
        engine_version:
          type: string
          description: Version of the verification engine
          example: "prep-regengine-1.0.0"
        initiated_by:
          type: string
          description: User who initiated verification
        initiated_from:
          type: string
          enum:
            - api
            - ui
          description: Source of verification request
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
