# Promtail Configuration for Prep Platform
# Log shipping agent that collects logs and sends to Loki
#
# This configuration:
# - Collects Docker container logs
# - Parses JSON logs from Prep services
# - Adds metadata labels for filtering
# - Handles multi-line stack traces

server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    tenant_id: prep
    batchwait: 1s
    batchsize: 1048576
    timeout: 10s
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10

scrape_configs:
  # Docker container logs
  - job_name: containers
    static_configs:
      - targets:
          - localhost
        labels:
          job: containerlogs
          __path__: /var/lib/docker/containers/*/*.log

    pipeline_stages:
      # Parse Docker JSON log format
      - json:
          expressions:
            log: log
            stream: stream
            time: time

      # Parse Prep JSON log format from the log field
      - json:
          expressions:
            level: level
            logger: logger
            message: message
            correlation_id: correlation_id
            service: service
            environment: environment
            version: version
            http_method: request.method
            http_path: request.path
            http_status: extra.http_status
            duration_ms: extra.duration_ms
            error_type: extra.error_type
          source: log

      # Set log level label
      - labels:
          level:
          logger:
          service:
          environment:
          correlation_id:
          http_method:
          http_path:

      # Format timestamp
      - timestamp:
          source: time
          format: RFC3339Nano

      # Output the message field as the log line
      - output:
          source: message

  # Kubernetes pod logs (when running in K8s)
  - job_name: kubernetes-pods
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      # Only scrape pods with the annotation
      - source_labels: [__meta_kubernetes_pod_annotation_promtail_io_scrape]
        action: keep
        regex: true

      # Use pod name as instance
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: instance

      # Use namespace
      - source_labels: [__meta_kubernetes_namespace]
        target_label: namespace

      # Use container name
      - source_labels: [__meta_kubernetes_pod_container_name]
        target_label: container

      # Use app label
      - source_labels: [__meta_kubernetes_pod_label_app]
        target_label: app

      # Set log path
      - replacement: /var/log/pods/*$1/*.log
        separator: /
        source_labels:
          - __meta_kubernetes_pod_uid
          - __meta_kubernetes_pod_container_name
        target_label: __path__

    pipeline_stages:
      # Parse CRI log format
      - cri: {}

      # Parse Prep JSON logs
      - json:
          expressions:
            level: level
            logger: logger
            message: message
            correlation_id: correlation_id
            service: service
            environment: environment
            version: version

      - labels:
          level:
          logger:
          service:
          environment:
          correlation_id:

      - output:
          source: message

  # System logs
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: varlogs
          __path__: /var/log/*.log

    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\S+ \S+) (?P<hostname>\S+) (?P<process>\S+): (?P<message>.*)$'

      - labels:
          hostname:
          process:

      - timestamp:
          source: timestamp
          format: "2006-01-02 15:04:05"

      - output:
          source: message

# Limits
limits_config:
  readline_rate_enabled: true
  readline_rate: 1000
  readline_burst: 10000
