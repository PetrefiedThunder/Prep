{
  "$schema": "https://grafana.com/schemas/grafana/alerting/v1alpha1/alert-rule-group.schema.json",
  "apiVersion": "1.0.0",
  "groups": [
    {
      "name": "api-latency",
      "folder": "SLOs",
      "interval": "1m",
      "rules": [
        {
          "uid": "prep-api-latency-sla",
          "title": "Prep API p95 latency above 300ms",
          "condition": "C",
          "noDataState": "NoData",
          "execErrState": "Error",
          "for": "5m",
          "annotations": {
            "summary": "Prep API p95 latency exceeded the 300ms budget",
            "runbook": "Refer to RUNBOOK.md#api-latency for remediation steps"
          },
          "labels": {
            "service": "prep-api",
            "severity": "critical"
          },
          "data": [
            {
              "refId": "A",
              "relativeTimeRange": {
                "from": 300,
                "to": 0
              },
              "datasourceUid": "${DS_PROMETHEUS}",
              "model": {
                "expr": "histogram_quantile(0.95, sum(rate(http_server_request_duration_seconds_bucket{service=\"prep-api\",route=~\"/api/v1/platform/(users/register|auth/login|bookings|payments/intent)\"}[5m])) by (le))",
                "interval": "",
                "legendFormat": "p95 latency",
                "datasource": {
                  "type": "prometheus",
                  "uid": "${DS_PROMETHEUS}"
                }
              }
            },
            {
              "refId": "C",
              "relativeTimeRange": {
                "from": 300,
                "to": 0
              },
              "datasourceUid": "__expr__",
              "model": {
                "expression": "A",
                "type": "threshold",
                "reducer": "last",
                "settings": {
                  "mode": "gt",
                  "threshold": 0.3
                },
                "datasource": {
                  "type": "__expr__",
                  "uid": "__expr__"
                }
              }
            }
          ]
        }
      ]
    }
  ]
}
