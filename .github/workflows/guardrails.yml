name: Guardrails
on: [pull_request]
jobs:
  secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: zricethezav/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with: { args: "--redact --no-git" }
      - name: Block env files
        run: |
          if git ls-files | grep -E '\\.env(\\.|$)|\\.pem$|\\.key$|\\.p12$' ; then
            echo "Secret-like files found. Blocked."; exit 1; fi
  static:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/ruff-action@v1
      - run: pipx run mypy .
      - run: pipx run bandit -r apps/ prep/
  supply-chain:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Trivy + SBOM
        uses: aquasecurity/trivy-action@0.20.0
        with: { scan-type: 'fs', format: 'sarif', output: 'trivy.sarif' }
