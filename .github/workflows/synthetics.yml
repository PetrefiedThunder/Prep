name: Synthetic regulatory monitors

on:
  schedule:
    - cron: '15 * * * *'
  workflow_dispatch:

jobs:
  run-synthetics:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    permissions:
      contents: read
      actions: read
      id-token: write
      pages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install synthetic dependencies
        run: |
          python -m pip install --upgrade pip
          pip install httpx

      - name: Execute synthetic monitors
        env:
          SYNTHETIC_BASE_URL: ${{ secrets.SYNTHETIC_BASE_URL }}
          SYNTHETIC_IDEMPOTENCY: ${{ secrets.SYNTHETIC_IDEMPOTENCY_KEY }}
          SYNTHETIC_JURISDICTIONS: ${{ vars.SYNTHETIC_JURISDICTIONS || 'san_francisco,joshua_tree' }}
        run: |
          python perf/synthetics/run_synthetics.py --output perf/synthetics/out/latest.json

      - name: Render job summary
        run: |
          echo "## Synthetic monitoring results" >> $GITHUB_STEP_SUMMARY
          echo "\n\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat perf/synthetics/out/latest.json >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        with:
          name: synthetics-latest
          path: perf/synthetics/out/latest.json

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: perf/synthetics/out

      - name: Deploy to GitHub Pages
        if: github.event_name != 'pull_request'
        uses: actions/deploy-pages@v4
