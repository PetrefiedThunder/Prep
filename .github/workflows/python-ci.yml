name: Python CI

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ release/** ]

jobs:
  guard-mass-deletion:
    name: Guard Mass Deletions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Check deletions
        run: |
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "Not a PR; skipping guard."
            exit 0
          fi
          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.sha }}"
          deletions=$(git diff --numstat "$base" "$head" | awk '{del+=$2} END {print del+0}')
          echo "Deletions: $deletions"
          labels=$(jq -r '.pull_request.labels[].name' "$GITHUB_EVENT_PATH" 2>/dev/null || true)
          if echo "$labels" | grep -qi '^mass-change-approved$'; then
            echo "mass-change-approved present; skipping guard."
            exit 0
          fi
          if [ "$deletions" -gt 5000 ] && [ ! -f SAFE_DELETE.md ]; then
            echo "::error ::Mass deletion detected ($deletions). Add SAFE_DELETE.md or apply label mass-change-approved."
            exit 1
          fi
          echo "Guard passed."

  qa:
    name: Lint, Typecheck, Test
    runs-on: ubuntu-latest
    needs: guard-mass-deletion
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Install package (+dev)
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Ruff
        run: ruff check prep
      - name: Mypy
        run: mypy prep
      - name: Pytest
        run: pytest -q
      - name: Fee schedule validation
        run: make etl.validate
      - name: API fee summary endpoint tests
        run: make api.summary.test
