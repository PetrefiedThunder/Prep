name: Python + Harborhomes CI

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ release/** ]

env:
  PIP_INDEX_URL: https://pypi.org/simple
  HTTP_PROXY: ""
  HTTPS_PROXY: ""
  http_proxy: ""
  https_proxy: ""
  NO_PROXY: ""
  no_proxy: ""

jobs:
  guard-mass-deletion:
    name: Guard Mass Deletions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check deletions
        run: |
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "Not a PR; skipping guard."
            exit 0
          fi
          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.sha }}"
          deletions=$(git diff --numstat "$base" "$head" | awk '{del+=$2} END {print del+0}')
          echo "Deletions: $deletions"
          labels=$(jq -r '.pull_request.labels[].name' "$GITHUB_EVENT_PATH" 2>/dev/null || true)
          if echo "$labels" | grep -qi '^mass-change-approved$'; then
            echo "mass-change-approved present; skipping guard."
            exit 0
          fi
          if [ "$deletions" -gt 5000 ] && [ ! -f SAFE_DELETE.md ]; then
            echo "::error ::Mass deletion detected ($deletions). Add SAFE_DELETE.md or apply label mass-change-approved."
            exit 1
          fi
          echo "Guard passed."

  python:
    name: Python validation
    runs-on: ubuntu-latest
    needs: guard-mass-deletion
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11.14"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            constraints.txt
            pyproject.toml
      - name: Upgrade pip
        run: python -m pip install --upgrade pip
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -e ".[dev]"
      - name: Ruff
        run: ruff check .
      - name: Mypy
        run: mypy prep
      - name: Pytest
        run: |
          mkdir -p artifacts
          pytest --json-report --json-report-file=artifacts/pytest-report.json
      - name: Upload pytest report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-report
          path: artifacts/pytest-report.json
          if-no-files-found: warn

  harborhomes:
    name: Harborhomes preview build
    runs-on: ubuntu-latest
    needs: guard-mass-deletion
    defaults:
      run:
        shell: bash
    env:
      NEXT_PUBLIC_API_BASE: https://example.com
    steps:
      - uses: actions/checkout@v4
      - name: Enable corepack
        run: corepack enable
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/harborhomes/package-lock.json
      - name: Install dependencies
        working-directory: apps/harborhomes
        run: npm ci
      - name: Lint
        working-directory: apps/harborhomes
        run: npm run lint
      - name: Build
        working-directory: apps/harborhomes
        run: npm run build
      - name: Upload Next build
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: harborhomes-next-build
          path: apps/harborhomes/.next
          if-no-files-found: warn
