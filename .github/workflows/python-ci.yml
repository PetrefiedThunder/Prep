name: Python CI

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ release/** ]

jobs:
  guard-mass-deletion:
    name: Guard Mass Deletions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check deletions
        run: |
          base="${{ github.event.pull_request.base.sha || 'origin/main' }}"
          head="${{ github.sha }}"
          deletions=$(git diff --numstat "$base" "$head" | awk '{del+=$2} END {print del+0}')
          echo "Deletions: $deletions"
          if [ $deletions -gt 5000 ] && [ ! -f SAFE_DELETE.md ]; then
            echo "::error ::Mass deletion detected ($deletions). Add SAFE_DELETE.md to justify."
            exit 1
          fi

  qa:
    name: Lint, Typecheck, Test
    runs-on: ubuntu-latest
    needs: guard-mass-deletion
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install package (+dev)
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Ruff
        run: ruff check prep
      - name: Mypy
        run: mypy prep
      - name: Pytest
        run: pytest -q
