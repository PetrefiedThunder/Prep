name: Scan Microservices

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'prepchef/services/**'
      - '.github/workflows/scan-microservices.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'prepchef/services/**'
  schedule:
    # Run weekly on Mondays at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  scan-node-dependencies:
    name: Scan Dependencies (${{ matrix.service }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - access-svc
          - admin-svc
          - audit-svc
          - auth-svc
          - availability-svc
          - booking-svc
          - compliance-svc
          - listing-svc
          - notif-svc
          - payments-svc
          - pricing-svc
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: prepchef/services/${{ matrix.service }}/package-lock.json

      - name: Install dependencies
        working-directory: prepchef/services/${{ matrix.service }}
        run: npm ci --ignore-scripts

      - name: Run npm audit
        working-directory: prepchef/services/${{ matrix.service }}
        run: |
          npm audit --audit-level=moderate --json > npm-audit-${{ matrix.service }}.json || true
          npm audit --audit-level=moderate || echo "::warning::Found vulnerabilities in ${{ matrix.service }}"
        continue-on-error: true

      - name: Upload npm audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-${{ matrix.service }}
          path: prepchef/services/${{ matrix.service }}/npm-audit-${{ matrix.service }}.json
          retention-days: 30

  scan-typescript-code:
    name: Scan TypeScript Code (${{ matrix.service }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - access-svc
          - admin-svc
          - audit-svc
          - auth-svc
          - availability-svc
          - booking-svc
          - compliance-svc
          - listing-svc
          - notif-svc
          - payments-svc
          - pricing-svc
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: prepchef/services/${{ matrix.service }}/package-lock.json

      - name: Install dependencies
        working-directory: prepchef/services/${{ matrix.service }}
        run: npm ci --ignore-scripts

      - name: Install ESLint security plugin
        working-directory: prepchef/services/${{ matrix.service }}
        run: npm install --no-save eslint eslint-plugin-security

      - name: Run ESLint security scan
        working-directory: prepchef/services/${{ matrix.service }}
        run: |
          npx eslint src --ext .ts,.js \
            --plugin security \
            --rule 'security/detect-object-injection: warn' \
            --rule 'security/detect-non-literal-regexp: warn' \
            --rule 'security/detect-unsafe-regex: error' \
            --rule 'security/detect-buffer-noassert: error' \
            --rule 'security/detect-child-process: warn' \
            --rule 'security/detect-disable-mustache-escape: error' \
            --rule 'security/detect-eval-with-expression: error' \
            --rule 'security/detect-no-csrf-before-method-override: error' \
            --rule 'security/detect-non-literal-fs-filename: warn' \
            --rule 'security/detect-non-literal-require: warn' \
            --rule 'security/detect-possible-timing-attacks: warn' \
            --rule 'security/detect-pseudoRandomBytes: error' \
            --format json --output-file eslint-security-${{ matrix.service }}.json || true
          npx eslint src --ext .ts,.js \
            --plugin security || echo "::warning::Found security issues in ${{ matrix.service }}"
        continue-on-error: true

      - name: Upload ESLint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eslint-security-${{ matrix.service }}
          path: prepchef/services/${{ matrix.service }}/eslint-security-${{ matrix.service }}.json
          retention-days: 30

  scan-docker-images:
    name: Scan Docker Image (${{ matrix.service }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - access-svc
          - admin-svc
          - audit-svc
          - auth-svc
          - availability-svc
          - booking-svc
          - compliance-svc
          - listing-svc
          - notif-svc
          - payments-svc
          - pricing-svc
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: prepchef/services/${{ matrix.service }}
          file: prepchef/services/${{ matrix.service }}/Dockerfile
          push: false
          load: true
          tags: prep/${{ matrix.service }}:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: prep/${{ matrix.service }}:scan
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-${{ matrix.service }}.sarif'
          category: 'trivy-${{ matrix.service }}'
        continue-on-error: true

      - name: Run Trivy vulnerability scanner (table format)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: prep/${{ matrix.service }}:scan
          format: 'table'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [scan-node-dependencies, scan-typescript-code, scan-docker-images]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: scan-results

      - name: Generate security summary
        run: |
          echo "# Microservices Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scanned Services" >> $GITHUB_STEP_SUMMARY
          echo "- access-svc" >> $GITHUB_STEP_SUMMARY
          echo "- admin-svc" >> $GITHUB_STEP_SUMMARY
          echo "- audit-svc" >> $GITHUB_STEP_SUMMARY
          echo "- auth-svc" >> $GITHUB_STEP_SUMMARY
          echo "- availability-svc" >> $GITHUB_STEP_SUMMARY
          echo "- booking-svc" >> $GITHUB_STEP_SUMMARY
          echo "- compliance-svc" >> $GITHUB_STEP_SUMMARY
          echo "- listing-svc" >> $GITHUB_STEP_SUMMARY
          echo "- notif-svc" >> $GITHUB_STEP_SUMMARY
          echo "- payments-svc" >> $GITHUB_STEP_SUMMARY
          echo "- pricing-svc" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Types" >> $GITHUB_STEP_SUMMARY
          echo "✅ NPM Dependency Audit" >> $GITHUB_STEP_SUMMARY
          echo "✅ TypeScript/JavaScript Security Scan (ESLint)" >> $GITHUB_STEP_SUMMARY
          echo "✅ Docker Image Vulnerability Scan (Trivy)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the 'Security' tab for detailed SARIF results." >> $GITHUB_STEP_SUMMARY

      - name: Upload combined scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: all-microservices-scan-results
          path: scan-results/
          retention-days: 90
